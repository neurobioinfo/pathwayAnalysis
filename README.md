# Running enrichment pathway analysis

This workflow uses the gene ontology from Gene Ontology (GO) project. 
It performs an over-representation analysis of GO terms in a list of significant genes using “ClusterProfiler” . 
This package performs statistical enrichment analysis in a list of differentially expressed genes using an hypergeometric test.

Input: 
1. A list of background DEG list (universe gene list) generated during a DEG analysis. This list contains all mapped genes from RNAseq aligment, that were tested in the differential expression analysis.
1. A list of significant differentially expressed genes (DEG list). This list of genes are significantly espressed genes extracted from the universe gene list. 

 
You can run this workflow in a RStudio session in your PC or, if you're using Compute Canada (CC)
clusters, you can run this workflow in an interactive R session.

## SETTING THE ENVIRONMENT

### 1. Create a project directory structure to hold scripts, data and analysis output. 

In your PC or in your project space (if you're in CC clusters), create next folders (replace
<project_directory> by your project folder name):
```
mkdir -p <project_directory>/data
mkdir -p <project_directory>/scripts
mkdir -p <project_directory>/output
```

### 2. Clone the repository in <project_directory>/scripts folder
```
cd  <project_directory>/scripts
git clone https://github.com/neurobioinfo/pathwayAnalysis
```

### 3. Input: DEG list files :

   a) all_genes_DEG list file
   
   b) significant_genes_DEG list file

A DEG list file is a csv file with "," as separator and "." for decimals, and it contains DEG associated statistics.

   Example of first 3 lines in a DEG list file generated by Sleuth:
```
"","target_id","ext_gene","pval","qval","b","se_b","mean_obs","var_obs","tech_var","sigma_sq","smooth_sigma_sq","final_sigma_sq"
"1","ENSG00000132386","SERPINF1",4.19261640763072e-199,6.39877116132601e-195,-2.23443556637803,0.0742219003691286,6.4509374442884,1.63778661186005,0.0029989099496231,0.00475780947707804,0.00526442579198417,0.00526442579198417
"2","ENSG00000182459","TEX19",2.80343280888276e-176,2.13929957645843e-172,2.44593401709134,0.0864062211045601,6.32253250309864,3.58410160816125,0.00573075354527296,-0.000382194802584816,0.00546829902308222,0.00546829902308222
"3","ENSG00000174460","ZCCHC12",1.53534263310991e-148,7.81079975550779e-145,1.77563800462695,0.0684082011589993,6.63809482324073,1.01199169891179,0.00198846390925134,0.00306274943721649,0.00503105906946383,0.00503105906946383
```

   Copy all_genes_DEG list file in <project_directory>/data
```
cp <DEG_analysis_directory>/<all_DEG_list.csv> <project_directory>/data
```
   Copy significant_genes_DEG list file in <project_directory>/data
```
cp <DEG_analysis_directory>/<significant_genes_DEG_list.csv> <project_directory>/data
```

### 4. Launch R or RStudio.

If you're using CC clusters, open a Salloc session, load bioconductor module and launch R:
```
salloc --time=02:00:00 -N 1 --ntasks-per-node=8 --mem-per-cpu=4G --account=rrg-grouleau-ac
module load StdEnv/2020  gcc/9.3.0 r-bundle-bioconductor/3.14
R
```

If you're using your PC, open a RStudio session and open the run_enrichment_pathway_analysis.R script. 

Run all following commands within the R interactive session or the RStudio session. These commands
are already written in the run_enrichment_pathway_analysis.R script.


### 5. Install required packages: tidyverse, DOSE, pathview, clusterProfiler, enrichplot, org.Hs.eg.db.


```
packages<-c(`tidyverse`, `DOSE`, `pathview`, `clusterProfiler`, `enrichplot`, `org.Hs.eg.db`)
lapply(packages, library, character.only = TRUE)

.libPaths( c( "~/R/x86_64-pc-linux-gnu-library/4.1" , .libPaths() ) )
```
6. Set the working directory and source the enrichment_pathway_analysis_2.R script.
```
setwd("<project_directory>")
source("scripts/pathwayAnalysis/R/enrichment_pathway_analysis_2.R")
```
This script contains custom functions to run clusterProfiler for a pathway enrichment analysis

## PATHWAY ENRICHMENT ANALYSIS BEGINS HERE

### 7. Generate EnrichGo objects and significant GO terms files for three Go categories: Biological processes (BP), Molecular function (MF) and cellular components (CC)

i. Read universe gene list
```
DEG_universe<-read.csv("data/<all_genes_DEG_list.csv>", header = TRUE, sep = ",", dec=".")
```
ii. Read significant DEG list
```
DEG_list<-read.csv("data/<significant_genes_DEG_list.csv>", header = TRUE, sep = ",", dec=".")
```
iii. Extract Genes ids list
```
genes_universe<-extract_genesID(DEG_universe)
genes_list<-extract_genesID(DEG_list)
```
iv. Run GO enrichment analysis. this function uses "enrichGO" from clusterProfiler. Here "BP", "MF"
"CC" refers to "biological processes", "Molecular function" and "Cellular component" respectively.

```
go_BP<-go_enrichment_obj(genes_list, genes_universe, "BP", 0.05, "<output_directory>/BP_go.csv")
go_MF<-go_enrichment_obj(genes_list, genes_universe, "MF", 0.05, "<output_directory>/MF_go.csv")
go_CC<-go_enrichment_obj(genes_list, genes_universe, "CC", 0.05, "<output_directory>/CC_go.csv")
```


Each one of these commands generate a list of enriched GO_terms for the respective GO category ( BP, MF or CC). 
This list contains statistics, p-value and gene sets associated to enriched GO_terms. All three lists are
saved in csv files.

These commands also generate EnrichGo objects for each category, which we use to make plots in next steps.


### 8. Generate dotplots, emaplots and cnetplots
i. Generate doptplots
```
go_dotPlot(go_BP, go_MF, go_CC, "output_directory")
```



ii. In RStudio: Look at the dotplots and choose the go_terms of each GO_category to be shown in emaplots and cnetplots.


In CC clusters: download dotplots and look  at them to chose the go_terms that you want to show in emaplots and cnetplots.
Run next command only if you're working in CC clusters. Without closing your current R session, open a new terminal and run this command to download dotplots:
                    
```
scp <CC_user_ID>@<CC_cluster_name>.computecanada.ca:<output_directory>/BP_go_dotplot.png <local_project_directory>
scp <CC_user_ID>@<CC_cluster_name>.computecanada.ca:<output_directory>/MF_go_dotplot.png <local_project_directory>
scp <CC_user_ID>@<CC_cluster_name>.computecanada.ca:<output_directory>/CC_go_dotplot.png <local_project_directory>
```

You also can chose to show a number of top significant go terms.

iii. In your Rstudio session, or in your R interactive session, create vectors with chosen go_terms for each category. Examples:                         

```
BP_cats=c("learning or memory", "central nervous system neuron differentiation",
          "synaptic vesicle exocytosis", "chemical synaptic transmission", "regulation of neurotransmitter levels")
MF_cats=5
CC_cats=c("presynapse", "integral component of presynaptic membrane", 
          "intrinsic component of presynaptic membrane", "presynaptic membrane")
```

iv. Generate enrichment GO plot (emaplot)
```
go_emaPlot(go_BP, go_MF, go_CC, "<output_directory>", BP_cats, MF_cats, CC_cats)
```

 v. Generate Cnetplots:
```
go_cnetPlot(DEG_list, go_BP, go_MF, go_CC, "<output_directory>", BP_cats, MF_cats, CC_cats)
```

### 9. Gsea analysis
 Functional class scoring (FCS) tools, such as GSEA, frequently use all genes gene-level
 statistics or log2 fold changes from the differential expression results.
 This analysis looks whether gene sets for particular biological pathways are enriched
 among the large positive or negative fold changes.

 Its important to run this analysis with all genes from the DEG analysis.
 It is possible to run this analysis with a subset of genes, but this reduces power test.
 Below, we present another method to test on a subset of genes
 

i. Using all genes DEG list, create a new list including genes fold change and Entrez IDs 

```
res_entrez<-add_entrezid(DEG_universe)
foldchanges<-name_foldchanges(res_entrez)
```

ii Run GSEA analysis, this function uses gseKEGG from "ClusterProfiler" to find
KEGG pathways.

```
gseaKEGG<-gseaKEGG_analysis(foldchanges, "<output_directory>")
```

iii Look at the found pathways and create a list of interesting pathways.
In RStudio: Look at pathways results table displayed in console
In CC clusters: Scrool up to look at the command output to find the list of enriched pathways
In both cases, create a vector including all pathways ID, of which you want to generate a GSEA plot and pathway image.
example

```
pathways<-c("hsa04360", "hsa05168", ...)
```

iv Create GSEAplot and KEGG image for chosen pathways
This function uses Pathview to generate pathway images

```
go_gseaKEGGplot(gseaKEGG, foldchanges, pathways, "<output_directory>")
```

### 10. KEGG enrichment analysis
You can use this function to look for enrichmed KEEG pathways in a subset of genes. 
For example, you can run this function for a list of significant DEG genes.

i. Create a gene Entrez IDs lists from the DEG subset list 
```
res_entrez_subset<-add_entrezid(DEG_list)
```

ii Run the enrichKEGG analysis which uses 
```
KEGGenrich<-enrichKEGG_analysis(res_entrez_subset, "<output_directory>")
```

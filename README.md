# Running enrichment pathway analysis

This workflow uses the gene ontology from Gene Ontology (GO) project. 
It performs over-representation (ORA) and pathways enrichment (GSEA) analysis of GO terms and KEEG pathways using “ClusterProfiler” .
ORA analysis performs statistical enrichment analysis using hypergeometric testing of significant DE genes against 
a background DE gene list.
 
Input: a DE gene list 

You can run this workflow in a RStudio session in your PC or, if you're using Compute Canada (CC)
clusters, you can run this workflow in an interactive R session.

## SETTING THE ENVIRONMENT

### 1. Create a project directory structure to hold scripts, data and analysis output. 

In your PC or in your project space (if you're in CC clusters), create next folders (replace
<project_directory> by your project folder name):
```
sudo apt install liblapack-dev libopenblas-dev

mkdir -p <project_directory>/data
mkdir -p <project_directory>/scripts
mkdir -p <project_directory>/results/GO_ORA
mkdir -p <project_directory>/results/GO_GSEA
mkdir -p <project_directory>/results/KEGG_ORA
mkdir -p <project_directory>/results/KEGG_GSEA
```

### 2.1 Create a folder to host the pathwayAnalysis repository
```
mkdir <repository_folder>
cd <repository_folder>
git clone https://github.com/neurobioinfo/pathwayAnalysis
```

### 2.2 Copy the "run_enrichment_pathway_analysis.R" file to the scripts folder in <project_directory>
```
cd <repository_folder>/pathwayAnalysis/R/run_enrichment_pathway_analysis.R <project_directory>/scripts
```
   You'll adapt this code file to analyze your data without modifying the original file.


### 3. Set the input: These is a DEG list file:

<all_genes_DEG list file>: A DEG list file is a csv file with "," as separator and "." for decimals, and it contains DEG associated statistics. These file contains all genes involved in the DGE analysis.

   Example of first 3 lines in a DEG list file generated by Sleuth:
```
"","target_id","ext_gene","pval","qval","b","se_b","mean_obs","var_obs","tech_var","sigma_sq","smooth_sigma_sq","final_sigma_sq"
"1","ENSG00000132386","SERPINF1",4.19261640763072e-199,6.39877116132601e-195,-2.23443556637803,0.0742219003691286,6.4509374442884,1.63778661186005,0.0029989099496231,0.00475780947707804,0.00526442579198417,0.00526442579198417
"2","ENSG00000182459","TEX19",2.80343280888276e-176,2.13929957645843e-172,2.44593401709134,0.0864062211045601,6.32253250309864,3.58410160816125,0.00573075354527296,-0.000382194802584816,0.00546829902308222,0.00546829902308222
"3","ENSG00000174460","ZCCHC12",1.53534263310991e-148,7.81079975550779e-145,1.77563800462695,0.0684082011589993,6.63809482324073,1.01199169891179,0.00198846390925134,0.00306274943721649,0.00503105906946383,0.00503105906946383
```

   Copy all_genes_DEG list file in <project_directory>/data
```
cp <DEG_analysis_directory>/<all_DEG_list.csv> <project_directory>/data
```


### 4. Launch R in CC clusters or RStudio in your PC.

In CC clusters, load bioconductor module and launch R:
```
module load StdEnv/2020  gcc/9.3.0 r-bundle-bioconductor/3.14
R
```

If you're using your PC, open a RStudio session and open the run_enrichment_pathway_analysis.R script.

### 5. Install required packages: tidyverse, DOSE, pathview, clusterProfiler, enrichplot, org.Hs.eg.db., ggupset

Run all following commands within an R interactive session in CC clusyers or the in a RStudio session. These commands
are already written in the run_enrichment_pathway_analysis.R script.


### 6. Set the <project_directory> as working directory and source the enrichment_pathway_analysis_2.R script.
```
setwd("<project_directory>")
set.seed(1)
source("repository_folder>/pathwayAnalysis/R/enrichment_pathway_analysis_2.R")
```
This script contains custom functions to run clusterProfiler for a pathway enrichment analysis

## 7. PATHWAY ENRICHMENT ANALYSIS BEGINS HERE
Declare variables:
```
DGE_universe_file="data/<DEG_file_name.csv>"
DGE_significant_file="data/DEG_sig_file_name.csv"
annotationType="<annotatyon type SYMBOL or ENTREZ>"
inputType="<DGE package name: Deseq2, Seurat, sleuth>"
go_ora_results="results/GO_ORA"
go_gsea_results="results/GO_GSEA"
kegg_ora_results="results/KEGG_ORA"
kegg_gsea_results="results/KEGG_GSEA"
```

1. Read universe gene list
```
DEG_universe<-read.csv(DGE_universe_file, header = TRUE, sep = ",", dec=".")
```
Rename gene_symbol and fold change columns
```
DEG_universe<-rename_columns(DEG_universe, inputType)
head(DEG_universe)
```
2. Subset differentially expressed genes
```
DEG_list <- subset(DEG_universe, padj < 0.05)
write.csv(as.data.frame(DEG_list), file=DGE_significant_file)
```
3. Extract Genes ids list
```
genes_universe<-extract_genesID(DEG_universe)
genes_list<-extract_genesID(DEG_list)
```
4. Run GO Overrepresentation analysis. this function uses "enrichGO" from clusterProfiler
"CC" refers to "biological processes", "Molecular function" and "Cellular component" respectively.

```
go_BP<-go_enrichment_obj(genes_list, genes_universe, "BP", 0.05, 0.6, go_ora_results, annotationType)
go_MF<-go_enrichment_obj(genes_list, genes_universe, "MF", 0.05, 0.6, go_ora_results, annotationType)
go_CC<-go_enrichment_obj(genes_list, genes_universe, "CC", 0.05, 0.6, go_ora_results, annotationType)
go_ALL<-go_enrichment_obj(genes_list, genes_universe, "ALL", 0.05, 0.6, go_ora_results, annotationType)
```


Each one of these commands generate a list of enriched GO_terms for the respective GO category ( BP, MF, CC. ALL). 
This list contains statistics, p-value and gene sets associated to enriched GO_terms. All three lists are
saved in csv files.

These commands also generate EnrichGo objects for each category, which we use to make plots in next steps.
5. GO enrichment analysis 
extract the log2 fold changes from theDGE list 
```
dim(DEG_universe)
res_entrez<-add_entrezid(DEG_universe)
foldchanges<-name_foldchanges(res_entrez, annotationType)
```
Run GSEA analysis for GO terms
```
gseaGo_BP<-gseaGO_analysis(foldchanges, "BP", 0.5, go_gsea_results, annotationType)
gseaGo_MF<-gseaGO_analysis(foldchanges, "MF", 0.5, go_gsea_results, annotationType)
gseaGo_CC<-gseaGO_analysis(foldchanges, "CC", 0.5, go_gsea_results, annotationType)
gseaGo_ALL<-gseaGO_analysis(foldchanges, "ALL", 0.5, go_gsea_results, annotationType)
```

### 8. Generate dotplots, emaplots and cnetplots
i. Generate doptplots
```
go_dotPlot(go_BP, go_MF, go_CC, go_ALL, go_ora_results, "ORA")
go_dotPlot(gseaGo_BP, gseaGo_MF, gseaGo_CC, gseaGo_ALL, go_gsea_results, "GSEA")
```



ii. In RStudio: Look at the dotplots and choose the go_terms of each GO_category to be shown in emaplots and cnetplots.


In CC clusters: download dotplots and look  at them to chose the go_terms that you want to show in emaplots and cnetplots.

Open the dotplots and chose the go terms of each category to show in the emaplot and cnetplot.
You also can chose to show a number of top significant go terms.
iii. In your Rstudio session, or in your R interactive session, create vectors with chosen go_terms for each category. Examples:
    Example: CC_cats=c("presynapse", "integral component of presynaptic membrane", "intrinsic component of presynaptic membrane")
In this code, we chose to pick all the go terms in the simplified lists

                       
#   Next code takes all terms in the simplified list of terms
```
# ORA number of term
BP_cats=dim(go_BP)[1]
MF_cats=dim(go_MF)[1]
CC_cats=dim(go_CC)[1]
ALL_cats=dim(go_ALL)[1]
```

Generate ORA GO plot (emaplot)
```
go_emaPlot(go_BP, go_MF, go_CC, go_ALL, go_ora_results, BP_cats, MF_cats, CC_cats, ALL_cats, "ORA")
```
GSEA number of term
```
BP_gsea_cats=dim(gseaGo_BP)[1]
MF_gsea_cats=dim(gseaGo_MF)[1]
CC_gsea_cats=dim(gseaGo_CC)[1]
ALL_gsea_cats=dim(gseaGo_ALL)[1]
```
Generate GSEA GO plot (emaplot)
```
go_emaPlot(gseaGo_BP, gseaGo_MF, gseaGo_CC, gseaGo_ALL, go_gsea_results, 
           BP_gsea_cats, MF_gsea_cats, CC_gsea_cats, ALL_gsea_cats, "GSEA")
```

 v. Generate Cnetplots:
```
go_cnetPlot(DEG_list, go_BP, go_MF, go_CC, go_ALL, go_ora_results, BP_cats, MF_cats, CC_cats, ALL_cats, "ORA")
go_cnetPlot(DEG_list, gseaGo_BP, gseaGo_MF, gseaGo_CC, gseaGo_ALL, go_gsea_results, 
            BP_gsea_cats, MF_gsea_cats, CC_gsea_cats, ALL_gsea_cats, "GSEA")
```

### 9. GSEA on KEEG pathways
 Functional class scoring (FCS) tools, such as GSEA, frequently use all genes gene-level
 statistics or log2 fold changes from the differential expression results.
 This analysis looks whether gene sets for particular biological pathways are enriched
 among the large positive or negative fold changes.

 Its important to run this analysis with all genes from the DEG analysis.
 It is possible to run this analysis with a subset of genes, but this reduces power test.
 Below, we present another method to test on a subset of genes
 

i. Using all genes DEG list, create a new list including genes fold change and Entrez IDs 

```
res_entrez<-add_entrezid(DEG_universe)
fc_entrez<-name_foldchanges(res_entrez, "ENTREZ")
```

ii Run GSEA analysis, this function uses gseKEGG from "ClusterProfiler" to find
KEGG pathways.

```
gseaKEGG<-gseaKEGG_analysis(fc_entrez, kegg_gsea_results, "gseaKEGG_pathways.csv")
```

iii Look at the pathways csv file and generate a list of interesting pathways
example

```
pathways<-c("hsa04360", "hsa05168", ...)
```

iv Create GSEAplot and KEGG image for chosen pathways
This function uses Pathview to generate pathway images

```
go_gseaKEGGplot(gseaKEGG, fc_entrez, pathways, kegg_gsea_results)
```

### 10. ORA analysis on KEGG pathway
You can use this function to look for enrichmed KEEG pathways in a subset of genes. 
For example, you can run this function for a list of significant DEG genes.

i. Create a gene Entrez IDs lists from the DEG subset list 
```
res_entrez_subset<-add_entrezid(DEG_list)
res_entrez<-add_entrezid(DEG_list)
dim(res_entrez_subset)
```

ii Run the enrichKEGG analysis which uses 
```
KEGGenrich<-enrichKEGG_analysis(res_entrez_subset, res_entrez, kegg_ora_results)
```
